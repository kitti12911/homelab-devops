- name: Install K3s server on master
  hosts: master
  become: true

  vars:
    k3s_install_flags: >-
      --disable servicelb
      --disable-cloud-controller
      --disable-network-policy
      --write-kubeconfig-mode 644
      --node-taint node-role.kubernetes.io/control-plane:NoSchedule

  tasks:
    - name: Check if K3s is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_installed

    - name: Install K3s server
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="{{ k3s_install_flags }}" sh -
      args:
        creates: /usr/local/bin/k3s
      when: not k3s_installed.stat.exists

    - name: Wait for K3s to be ready
      ansible.builtin.command: /usr/local/bin/k3s kubectl get nodes
      register: k3s_ready
      changed_when: false
      retries: 12
      delay: 10
      until: k3s_ready.rc == 0

- name: Copy kubeconfig to control machine
  hosts: master
  gather_facts: false

  vars:
    k3s_fetched_config: "/tmp/k3s-master-config.yaml"
    master_api: "https://{{ hostvars[groups['master'][0]].ansible_host }}:6443"

  tasks:
    - name: Fetch kubeconfig from master
      ansible.builtin.fetch:
        src: /etc/rancher/k3s/k3s.yaml
        dest: "{{ k3s_fetched_config }}"
        flat: true
      run_once: true

    - name: Ensure .kube directory exists on control machine
      ansible.builtin.file:
        path: "{{ lookup('env', 'HOME') }}/.kube"
        state: directory
        mode: "0755"
      run_once: true
      delegate_to: localhost
      become: false

    - name: Read fetched kubeconfig
      ansible.builtin.slurp:
        src: "{{ k3s_fetched_config }}"
      register: k3s_config_slurp
      run_once: true
      delegate_to: localhost
      become: false

    - name: Write kubeconfig with master API address
      ansible.builtin.copy:
        content: "{{ (k3s_config_slurp.content | b64decode) | replace('https://127.0.0.1:6443', master_api) }}"
        dest: "{{ lookup('env', 'HOME') }}/.kube/config"
        mode: "0600"
      run_once: true
      delegate_to: localhost
      become: false
