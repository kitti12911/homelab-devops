# renovate: datasource=helm registryUrl=https://argoproj.github.io/argo-helm depName=argo-cd
# version: 9.4.2

global:
  logging:
    level: error
  domain: argocd.lan
  nodeSelector:
    node-role.kubernetes.io/object_storage: "true"
  tolerations:
    - key: dedicated
      operator: Equal
      value: object_storage
      effect: NoSchedule

dex:
  enabled: false

configs:
  cm:
    url: https://argocd.lan
    kustomize.buildOptions: "--enable-alpha-plugins --enable-exec"
    oidc.config: |
      name: Keycloak
      issuer: https://keycloak.lan/realms/homelab
      clientID: argocd
      clientSecret: $oidc.keycloak.clientSecret
      requestedScopes: ["openid", "profile", "email"]
      logoutURL: https://keycloak.lan/realms/homelab/protocol/openid-connect/logout?post_logout_redirect_uri=https%3A%2F%2Fargocd.lan&client_id=argocd
  rbac:
    policy.csv: |
      g, /argocd-admins, role:admin
      g, /argocd-viewers, role:readonly
    scopes: "[groups]"
  params:
    server.insecure: "true"
    controller.status.processors: "5"
    controller.operation.processors: "3"
    controller.kubectl.parallelism.limit: "5"
    timeout.reconciliation: "300"

controller:
  podAnnotations:
    reloader.stakater.com/auto: "true"
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      memory: 1Gi

server:
  podAnnotations:
    reloader.stakater.com/auto: "true"
  volumes:
    - name: homelab-ca
      configMap:
        name: homelab-ca
  volumeMounts:
    - name: homelab-ca
      mountPath: /etc/ssl/certs/homelab
      readOnly: true
  env:
    - name: SSL_CERT_DIR
      value: /etc/ssl/certs/homelab
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 256Mi
  httproute:
    enabled: true
    parentRefs:
      - name: traefik
        namespace: default
        sectionName: https
    hostnames:
      - argocd.lan

repoServer:
  podAnnotations:
    reloader.stakater.com/auto: "true"
  env:
    - name: SOPS_AGE_KEY_FILE
      value: /sops/age/keys.txt
    - name: HELM_PLUGINS
      value: /custom-tools/helm-plugins/
    - name: HELM_SECRETS_SOPS_PATH
      value: /custom-tools/sops
    - name: HELM_SECRETS_BACKEND
      value: sops
    - name: XDG_CONFIG_HOME
      value: /custom-tools/.config
  volumes:
    - name: sops-age
      secret:
        secretName: sops-age
    - name: custom-tools
      emptyDir: {}
  volumeMounts:
    - name: sops-age
      mountPath: /sops/age
    - name: custom-tools
      mountPath: /custom-tools
  initContainers:
    - name: install-sops
      image: alpine:3.23
      command: [sh, -ec]
      args:
        - |
          set -euo pipefail
          cd /custom-tools
          mkdir -p /custom-tools/helm-plugins

          wget -qO sops https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.arm64
          echo "c71d32f74b3a73ce283affe6ed36e221a8f1476c3d37963f60bd962fb1676681  sops" | sha256sum -c -
          chmod +x sops

          wget -qO helm-secrets.tar.gz https://github.com/jkroepke/helm-secrets/releases/download/v4.7.5/helm-secrets.tar.gz
          echo "f1e332f159e67100612815dcb8773ea46ae75a682fcf058c29bd300581fe2401  helm-secrets.tar.gz" | sha256sum -c -
          tar -C /custom-tools/helm-plugins -xzf helm-secrets.tar.gz
          rm helm-secrets.tar.gz

          wget -qO ksops.tar.gz https://github.com/viaduct-ai/kustomize-sops/releases/download/v4.4.0/ksops_4.4.0_Linux_arm64.tar.gz
          echo "df0ced165a73801c7f03e4e650314e645f050c1a453f891f6f7ca45695af6fc6  ksops.tar.gz" | sha256sum -c -
          tar xz -f ksops.tar.gz
          rm ksops.tar.gz

          mkdir -p /custom-tools/.config/kustomize/plugin/viaduct.ai/v1/ksops
          mv ksops /custom-tools/.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops
      volumeMounts:
        - name: custom-tools
          mountPath: /custom-tools
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 256Mi

redis:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      memory: 128Mi