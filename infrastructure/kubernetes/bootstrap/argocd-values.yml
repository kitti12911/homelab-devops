global:
  domain: argocd.lan
  nodeSelector:
    node-role.kubernetes.io/control-plane: "true"
  tolerations:
    - key: node-role.kubernetes.io/control-plane
      operator: Exists
      effect: NoSchedule
    - key: node-role.kubernetes.io/master
      operator: Exists
      effect: NoSchedule

dex:
  enabled: false

configs:
  cm:
    url: https://argocd.lan
    oidc.tls.insecure.skip.verify: "true"
    kustomize.buildOptions: "--enable-alpha-plugins --enable-exec"
    oidc.config: |
      name: Keycloak
      issuer: https://keycloak.lan/realms/homelab
      clientID: argocd
      clientSecret: $oidc.keycloak.clientSecret
      requestedScopes: ["openid", "profile", "email"]
      logoutURL: https://keycloak.lan/realms/homelab/protocol/openid-connect/logout?post_logout_redirect_uri=https%3A%2F%2Fargocd.lan&client_id=argocd
  rbac:
    policy.csv: |
      g, /argocd-admins, role:admin
      g, /argocd-viewers, role:readonly
    scopes: "[groups]"
  params:
    server.insecure: "true"

controller:
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi

server:
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 256Mi
  httproute:
    enabled: true
    parentRefs:
      - name: traefik
        namespace: default
        sectionName: https
    hostnames:
      - argocd.lan

repoServer:
  env:
    - name: SOPS_AGE_KEY_FILE
      value: /sops/age/keys.txt
    - name: HELM_PLUGINS
      value: /custom-tools/helm-plugins/
    - name: HELM_SECRETS_SOPS_PATH
      value: /custom-tools/sops
    - name: HELM_SECRETS_BACKEND
      value: sops
    - name: XDG_CONFIG_HOME
      value: /custom-tools/.config
  volumes:
    - name: sops-age
      secret:
        secretName: sops-age
    - name: custom-tools
      emptyDir: {}
  volumeMounts:
    - name: sops-age
      mountPath: /sops/age
    - name: custom-tools
      mountPath: /custom-tools
  initContainers:
    - name: install-sops
      image: alpine:3.23
      command: [sh, -ec]
      args:
        - |
          cd /custom-tools
          mkdir -p /custom-tools/helm-plugins
          wget -qO sops https://github.com/getsops/sops/releases/download/v3.11.0/sops-v3.11.0.linux.arm64
          chmod +x sops
          wget -qO- https://github.com/jkroepke/helm-secrets/releases/download/v4.7.5/helm-secrets.tar.gz | tar -C /custom-tools/helm-plugins -xzf-
          wget -qO- https://github.com/viaduct-ai/kustomize-sops/releases/download/v4.4.0/ksops_4.4.0_Linux_arm64.tar.gz | tar xz
          mkdir -p /custom-tools/.config/kustomize/plugin/viaduct.ai/v1/ksops
          mv ksops /custom-tools/.config/kustomize/plugin/viaduct.ai/v1/ksops/ksops
      volumeMounts:
        - name: custom-tools
          mountPath: /custom-tools
  resources:
    requests:
      cpu: 50m
      memory: 128Mi
    limits:
      memory: 256Mi

redis:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      memory: 128Mi